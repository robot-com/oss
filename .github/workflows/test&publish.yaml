name: Test & Publish
on:
  push:
    branches:
      - main
permissions:
  id-token: write
  contents: read
jobs:
  test:
    env:
      MQTT_HOST: ${{ secrets.MQTT_HOST }}
      MQTT_USER: ${{ secrets.MQTT_USER }}
      MQTT_PASS: ${{ secrets.MQTT_PASS }}
      NATS_URL: ${{ secrets.NATS_URL }}
      NATS_TOKEN: ${{ secrets.NATS_TOKEN }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24.x"
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - run: pnpm install --frozen-lockfile
      - name: Create empty .env files
        run: find packages -type d -maxdepth 1 -mindepth 1 -exec touch {}'/.env' \;
      - name: Run tests
        run: pnpm -r run test
  publish:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24.x"
          registry-url: "https://registry.npmjs.org"

      - name: Update latest npm
        run: npm install -g npm@latest
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - run: pnpm install --frozen-lockfile
      - run: pnpm -r run build
      - run: pnpm -r run publish --access public --no-git-checks --provenance
      - name: Show npm debug log
        if: failure()
        run: |
          echo "=== NPM DEBUG LOG ==="
          cat /home/runner/.npm/_logs/* || echo "No log found"
